# Y86模拟器安装
本章部分习题需要Y86模拟器，安装步骤如下：
1. 源码下载：http://csapp.cs.cmu.edu/public/students.html
2. 安装词法分析工具：sudo apt-get install bison flex
3. 安装Tcl/Tk 支持图形界面(可选)：sudo apt-get install tcl8.5-dev tk8.5-dev tcl8.5 tk8.5
4. 解压：tar xf sim.tar
5. 修改Makefile文件
```bash
GUIMODE=-DHAS_GUI # 如果第3步安装了GUI支持则打开此行
TKLIBS=-L/usr/lib/ -ltk8.5 -ltcl8.5 # 根据本地路径修改
TKINC=-I/usr/include/tcl8.5 # 根据本地路径修改
```
6. 编译：cd sim && make clean && make
7. 执行参考http://csapp.cs.cmu.edu/public/students.html中**simguide.pdf**
# homework
* 4.45<br>
A: 不正确, pushq %rsp期望将rsp的旧值入栈，当前代码将更新后的值入栈<br>
B:
```c++
movq REG, -8(%rsp)
subq $8, %rsp
```
* 4.46<br>
A: 不正确, popq %rsp期望将rsp初始位置的值更新到rsp中，当前代码在更新后又将rsp增加<br>
B:
```c++
addq $8, %rsp
movq 8(%rsp), REG
```
* 4.47<br>
A:
```c++
void bubble_p(long *data, long count) {
  long *i, *last;
  for (last = data + count - 1; last > data; last--) {
    for (i = data; i < last; i++)
      if (*(i + 1) < *i) {
        /* Swap adjacent elements */
        long t = *(i + 1);
        *(i + 1) = *i;
        *i = t;
      }
  }
}
```
B:
见文件4_47.ys.<br>
使用yas编译后使用yis执行结果如下：
```bash
Stopped in 405 steps at PC = 0x13.  Status 'HLT', CC Z=1 S=0 O=0
Changes to registers:
%rax:   0x0000000000000000      0x0000000000000020
%rcx:   0x0000000000000000      0x0000000000000002
%rdx:   0x0000000000000000      0x0000000000000001
%rsp:   0x0000000000000000      0x0000000000000200
%rsi:   0x0000000000000000      0x0000000000000018
%rdi:   0x0000000000000000      0x0000000000000018
%r8:    0x0000000000000000      0x0000000000000008
%r11:   0x0000000000000000      0xffffffffffffffff

Changes to memory:
0x0018: 0x0000000000000008      0x0000000000000001
0x0020: 0x0000000000000007      0x0000000000000002
0x0028: 0x0000000000000006      0x0000000000000003
0x0030: 0x0000000000000005      0x0000000000000004
0x0038: 0x0000000000000004      0x0000000000000005
0x0040: 0x0000000000000003      0x0000000000000006
0x0048: 0x0000000000000002      0x0000000000000007
0x0050: 0x0000000000000001      0x0000000000000008
0x01f0: 0x0000000000000000      0x0000000000000075
0x01f8: 0x0000000000000000      0x0000000000000013
```
可以看到输入数据已经按照升序正确排序，共执行405次指令<br>
* 4.48<br>
见文件4_48.ys.<br>
使用yas编译后使用yis执行结果如下：
```bash
Stopped in 461 steps at PC = 0x13.  Status 'HLT', CC Z=1 S=0 O=0
Changes to registers:
%rax:   0x0000000000000000      0x0000000000000020
%rcx:   0x0000000000000000      0x0000000000000002
%rdx:   0x0000000000000000      0x0000000000000001
%rsp:   0x0000000000000000      0x0000000000000200
%rsi:   0x0000000000000000      0x0000000000000018
%rdi:   0x0000000000000000      0x0000000000000018
%r8:    0x0000000000000000      0x0000000000000008
%r11:   0x0000000000000000      0xffffffffffffffff

Changes to memory:
0x0018: 0x0000000000000008      0x0000000000000001
0x0020: 0x0000000000000007      0x0000000000000002
0x0028: 0x0000000000000006      0x0000000000000003
0x0030: 0x0000000000000005      0x0000000000000004
0x0038: 0x0000000000000004      0x0000000000000005
0x0040: 0x0000000000000003      0x0000000000000006
0x0048: 0x0000000000000002      0x0000000000000007
0x0050: 0x0000000000000001      0x0000000000000008
0x01f0: 0x0000000000000000      0x0000000000000075
0x01f8: 0x0000000000000000      0x0000000000000013
```
可以看到输入数据已经按照升序正确排序，共执行461次指令<br>
* 4.49<br>
参考：https://dreamanddead.github.io/CSAPP-3e-Solutions/chapter4/4.49/<br>
异或操作有如下特性：a^b^a=b, a^b^b=a，因此使用3次异或操作效果相当于一次swap
```bash
x = a, y = b, c = a ^ b
x = x ^ y # x=c,y=b
y = x ^ y # x=c,y=a
x = x ^ y # x=b,y=a

如果在第一次异或后修改y的值
x = a, y = b, c = a ^ b
x = x ^ y # x=c,y=b
y = a     # x=c,y=a
y = x ^ y # x=c,y=b
x = x ^ y # x=a,y=b
```
根据此方法可以只使用一次条件传送指令实现swap,具体见文件4_49.ys.
使用yas编译后使用yis执行结果如下：
```bash
Stopped in 517 steps at PC = 0x13.  Status 'HLT', CC Z=1 S=0 O=0
Changes to registers:
%rax:   0x0000000000000000      0x0000000000000020
%rcx:   0x0000000000000000      0x0000000000000002
%rdx:   0x0000000000000000      0x0000000000000001
%rsp:   0x0000000000000000      0x0000000000000200
%rsi:   0x0000000000000000      0x0000000000000018
%rdi:   0x0000000000000000      0x0000000000000018
%r8:    0x0000000000000000      0x0000000000000008
%r11:   0x0000000000000000      0xffffffffffffffff
%r12:   0x0000000000000000      0x0000000000000002

Changes to memory:
0x0018: 0x0000000000000008      0x0000000000000001
0x0020: 0x0000000000000007      0x0000000000000002
0x0028: 0x0000000000000006      0x0000000000000003
0x0030: 0x0000000000000005      0x0000000000000004
0x0038: 0x0000000000000004      0x0000000000000005
0x0040: 0x0000000000000003      0x0000000000000006
0x0048: 0x0000000000000002      0x0000000000000007
0x0050: 0x0000000000000001      0x0000000000000008
0x01f0: 0x0000000000000000      0x0000000000000075
0x01f8: 0x0000000000000000      0x0000000000000013
```
可以看到输入数据已经按照升序正确排序，共执行517次指令<br>
* 4.50<br>

